// Prisma Schema for Platium.vip Game Streaming
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER PROFILES
// ============================================================================

model UserProfile {
  id                String   @id @default(uuid()) @map("id")
  platiumUserId     String   @unique @map("platium_user_id")
  username          String   @unique
  displayName       String?  @map("display_name")
  avatarUrl         String?  @map("avatar_url")
  preferredEmulator String?  @default("retroarch") @map("preferred_emulator")
  isOnline          Boolean  @default(false) @map("is_online")
  lastSeenAt        DateTime @default(now()) @map("last_seen_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")

  // Relations
  createdSessions GameSession[]        @relation("SessionCreator")
  library         UserGameLibrary[]
  participations  SessionParticipant[]
  chatMessages    SessionChat[]
  sessionHistory  SessionHistory[]

  @@index([username])
  @@index([isOnline])
  @@map("user_profiles")
}

// ============================================================================
// GAMES
// ============================================================================

model Game {
  id             String   @id @default(uuid()) @map("id")
  title          String   @map("title")
  slug           String   @unique @map("slug")
  system         String   @map("system")
  year           Int?     @map("year")
  genre          String?  @map("genre")
  playerCount    Int      @default(1) @map("player_count")
  romPath        String?  @map("rom_path")
  emulator       String   @default("retroarch") @map("emulator")
  emulatorCore   String?  @map("emulator_core")
  coverArtUrl    String?  @map("cover_art_url")
  screenshotUrls String[] @default([]) @map("screenshot_urls")
  description    String?  @db.Text
  rating         Decimal? @db.Decimal(3, 2)
  playCount      Int      @default(0) @map("play_count")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @map("updated_at")

  // Relations
  sessions       GameSession[]
  libraryEntries UserGameLibrary[]
  sessionHistory SessionHistory[]

  @@index([title])
  @@index([system])
  @@index([isActive])
  @@map("games")
}

// ============================================================================
// GAME SESSIONS
// ============================================================================

model GameSession {
  id              String        @id @default(uuid()) @map("id")
  gameId          String        @map("game_id")
  createdBy       String        @map("created_by")
  sessionCode     String?       @unique @map("session_code")
  status          SessionStatus @default(STARTING)
  sessionType     SessionType   @default(SINGLE)
  isPrivate       Boolean       @default(false) @map("is_private")
  maxPlayers      Int           @default(1) @map("max_players")
  currentPlayers  Int           @default(0) @map("current_players")
  spectatorCount  Int           @default(0) @map("spectator_count")
  containerId     String?       @map("container_id")
  containerIp     String?       @map("container_ip")
  containerPort   Int?          @map("container_port")
  videoQuality    VideoQuality  @default(Q1080P)
  fps             Int           @default(60)
  startedAt       DateTime      @default(now()) @map("started_at")
  endedAt         DateTime?     @map("ended_at")
  lastActivityAt  DateTime      @default(now()) @map("last_activity_at")
  durationMinutes Int?          @map("duration_minutes")

  // Relations
  game         Game                 @relation(fields: [gameId], references: [id], onDelete: Cascade)
  creator      UserProfile          @relation("SessionCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  participants SessionParticipant[]
  chatMessages SessionChat[]
  history      SessionHistory[]

  @@index([status])
  @@index([startedAt])
  @@map("game_sessions")
}

enum SessionStatus {
  STARTING @map("starting")
  ACTIVE   @map("active")
  ENDING   @map("ending")
  ENDED    @map("ended")
  ERROR    @map("error")
}

enum SessionType {
  SINGLE      @map("single")
  MULTIPLAYER @map("multiplayer")
  SPECTATE    @map("spectate")
}

enum VideoQuality {
  Q720P  @map("720p")
  Q1080P @map("1080p")
  Q1440P @map("1440p")
}

// ============================================================================
// SESSION PARTICIPANTS
// ============================================================================

model SessionParticipant {
  sessionId            String          @map("session_id")
  userId               String          @map("user_id")
  role                 ParticipantRole @default(PLAYER)
  isHost               Boolean         @default(false) @map("is_host")
  joinedAt             DateTime        @default(now()) @map("joined_at")
  leftAt               DateTime?       @map("left_at")
  totalDurationMinutes Int             @default(0) @map("total_duration_minutes")

  // Relations
  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([sessionId, userId])
  @@index([userId])
  @@map("session_participants")
}

enum ParticipantRole {
  PLAYER    @map("player")
  SPECTATOR @map("spectator")
  MODERATOR @map("moderator")
}

// ============================================================================
// SESSION CHAT
// ============================================================================

model SessionChat {
  id        String      @id @default(uuid()) @map("id")
  sessionId String      @map("session_id")
  userId    String      @map("user_id")
  message   String      @db.Text
  type      MessageType @default(CHAT)
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@index([userId])
  @@map("session_chat")
}

enum MessageType {
  CHAT       @map("chat")
  SYSTEM     @map("system")
  GAME_EVENT @map("game_event")
}

// ============================================================================
// USER GAME LIBRARY
// ============================================================================

model UserGameLibrary {
  userId          String     @map("user_id")
  gameId          String     @map("game_id")
  status          GameStatus @default(NOT_PLAYED)
  playTimeMinutes Int        @default(0) @map("play_time_minutes")
  lastPlayedAt    DateTime?  @map("last_played_at")
  rating          Int?
  addedAt         DateTime   @default(now()) @map("added_at")

  // Relations
  user UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@id([userId, gameId])
  @@index([userId])
  @@map("user_game_library")
}

enum GameStatus {
  NOT_PLAYED @map("not_played")
  PLAYING    @map("playing")
  COMPLETED  @map("completed")
  FAVORITE   @map("favorite")
}

// ============================================================================
// SESSION HISTORY
// ============================================================================

model SessionHistory {
  id              String          @id @default(uuid()) @map("id")
  sessionId       String          @map("session_id")
  userId          String          @map("user_id")
  gameId          String          @map("game_id")
  role            ParticipantRole
  startedAt       DateTime        @map("started_at")
  endedAt         DateTime        @map("ended_at")
  durationMinutes Int             @map("duration_minutes")
  totalPlayers    Int             @default(1) @map("total_players")

  // Relations
  session GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  game    Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@index([userId, endedAt])
  @@index([gameId, endedAt])
  @@map("session_history")
}
